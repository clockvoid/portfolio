<!DOCTYPE HTML><html><head><title>clockvoid - iOSDC 2020 前夜祭</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="twitter:card" content="summary"><meta name="og:site" content="@clockvoid"><meta name="og:title" content="iOSDC 2020 前夜祭"><meta name="og:image" content="https://github.com/clockvoid.png"><meta name="og:type" content="article"><link rel="shortcut icon" href="../favicon.ico" type="image/x-icon"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/dracula.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>window.twttr=(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))returnt;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);t._e=[];t.ready=function(f){t._e.push(f);};return t;}(document,'script','twitter-wjs'));</script><link rel="stylesheet" href="../css/mystyles.css"></head><body class="has-navbar-fixed-top"><div class="navbar is-fixed-top has-shadow"><div class="container"><div class="navbar-brand"><div class="navbar-item"><a href="../"><figure class="image"><img class="is-rounded" src="https://github.com/clockvoid.png" style="height: 1.75rem; width: 1.75rem;"></figure></a></div><div class="navbar-burger burger" onclick="document.querySelector('.navbar-menu').classList.toggle('is-active');"><span></span><span></span><span></span></div></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="../about.html">About</a><a class="navbar-item" href="../blog.html">Blog</a><a class="navbar-item" href="../works.html">Works</a></div><div class="navbar-end"><div class="navbar-item"><a class="button is-primary" href="https://github.com/clockvoid/portfolio/blob/master/posts/2020-09-19-iosdc-0.md "><span class="icon"><i class="fab fa-github"></i></span><span>View it in GitHub</span></a></div></div></div></div></div><div class="container"><div class="column is-10 is-offset-1"><h1 class="title">iOSDC 2020 前夜祭</h1><a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=iOSDC 2020 前夜祭&amp;via=clockvoid">Tweet</a><p class="date">Posted on 2020-09-19 </p><p style="margin-bottom: 1.5rem"> 2020年のiOSDC第0日目で気になったセッションや初めて知ったことのまとめです </p><article class="content"><h3 class="title is-4 bd-anchor-title" id="前夜祭説明会">前夜祭説明会</h3>
<p>iOSDCの配信はニコニコ生放送を使ってやるとのこと．</p>
<p>ドワンゴのオフィスを借りてやっているとのこと．</p>
<p>グリーンバックでリアルタイムに映像を合成している模様．すごい．</p>
<h4 class="title is-5 bd-anchor-title" id="コミュニケーションを大切にしている">コミュニケーションを大切にしている</h4>
<ul>
<li>今年もやっていきましょう．</li>
<li>Twitter: ハッシュタグ</li>
<li>Discord: 発生可能パブリックビューイングチャンネルが有る．ここでしゃべることが可能
<ul>
<li>雑談するチャンネルとかもある（ワークするかわからないけどやってみて）</li>
</ul></li>
<li>ニコ生コメントもやってね</li>
</ul>
<h4 class="title is-5 bd-anchor-title" id="ハッシュタグ">ハッシュタグ</h4>
<ul>
<li>全体
<ul>
<li>#iosdc</li>
</ul></li>
<li>トラックごと
<ul>
<li>#iosdc #a</li>
</ul></li>
<li>Discord
<ul>
<li>#iosdc #vc</li>
</ul></li>
</ul>
<h4 class="title is-5 bd-anchor-title" id="イベント">イベント</h4>
<ul>
<li>Ask the Speaker
<ul>
<li>今年はDiscordでやる</li>
<li>「面白かったです」だけでも良いし，スライドもう一度見せてください，でもOK</li>
</ul></li>
<li>Feedback
<ul>
<li>シリアルコードの書いてあったメールのURLから送れる</li>
<li>コメントなしでもOK．「いいね」だけでもOK</li>
</ul></li>
<li>ツイート企画
<ul>
<li>ヒミツのキーワードが30個くらいある．Tweetでたまたま含まれていたら抽選に参加できる</li>
<li>最終日のお昼に一つづつキーワードを開示</li>
</ul></li>
</ul>
<h4 class="title is-5 bd-anchor-title" id="day-1">Day 1</h4>
<ul>
<li>10:00からオープニング・セッション</li>
<li>スポンサー紹介や企画紹介など，頑張ったので是非参加してとのこと
<ul>
<li>後でYouTubeにも投稿されるが，喋りは含まれない</li>
</ul></li>
<li>おっかけ再生もできる</li>
</ul>
<h3 class="title is-4 bd-anchor-title" id="sourcekit-lspをブラウザでコードを読むために活用する">SourceKit-LSPをブラウザでコードを読むために活用する</h3>
<p>一瞬音が聞こえないトラブルが有りましたが，なんとか復旧</p>
<p>ブラウザでもXcodeを使っているようにコードジャンプとかができるようになる</p>
<p>すでにかつみさんがSafariとChromeのブラウザ拡張を<a href="https://chrome.google.com/webstore/detail/sourcekit-for-chrome/ndfileljkldjnflefdckeiaedelndafe">公開している</a>．</p>
<p>レポジトリは<a href="https://github.com/kishikawakatsumi/SourceKitForSafari">ここ</a></p>
<p>→このブラウザ拡張はGitHubのコードビューワで使用可能</p>
<p>GitHub Code Navigationがあるので，JavaとかJavaScriptiならブラウザ拡張はなくても同じことができる．（Swift向けにはないので，作った）</p>
<p>SourceKit-LSPとは，Appleがオープンソースで開発している，SwiftとObjective-C向けのLSP．</p>
<h4 class="title is-5 bd-anchor-title" id="sourcekit-lspを使ってみる">SourceKit-LSPを使ってみる</h4>
<p>Xcode 11.4からSourceKit-LSPが標準でついてくるので，Xcodeをインストールするだけで入手可能</p>
<p>あとは自分が使っているLanguage Clientから使えば良い（？）</p>
<p>発表ではSouceKit-LSPのVSCode拡張をビルドしてインストールしてた．これをやるとSouceKit-LSPの設定項目がVSCodeに現れるらしい．ここで実行用バイナリのパスを設定するとのことだが，おそらくこれはLanguage Clientとしての機能を持っているんだと思う．</p>
<p>標準設定ではmacOS向けの設定になっていて，UIKitとかが使えない．そのため，設定でiOSのプロジェクトとしてビルドするようにオプションを設定し直す必要がある．</p>
<h4 class="title is-5 bd-anchor-title" id="soucekit-lspと通信するときの仕組みを見る">SouceKit-LSPと通信するときの仕組みを見る</h4>
<p>JSON-RPCとか言うものを使用してプロセス間通信する</p>
<p>関数の呼び出し方と返り値をJSONで表現するプロトコル．</p>
<p>headerでJSONの長さを格納する必要がある．→受け取り側は毎回サイズを計算しなくてはならない．</p>
<p>レスポンスは一度に帰ってこず，分割して帰ってくることもある．</p>
<p>ただし，基本的にはライブラリがあるので，普通はこういう計算はしなくてもOK</p>
<p>VSCodeでログをVerboseにするとログが全部出てくるので，メッセージの形とかがわかるようになる</p>
<figure>
<img src="https://i.imgur.com/d05yOzim.png" class="image is-in-article" alt="ライフサイクル" />
<figcaption aria-hidden="true">ライフサイクル</figcaption>
</figure>
<h4 class="title is-5 bd-anchor-title" id="自分で書いたプログラムで通信する">自分で書いたプログラムで通信する</h4>
<p>LSPは通信に関する仕様は規定されていない→現状，殆どのLSPは標準入出力を使用している模様</p>
<p>パイプでSourceKit-LSPのプロセスからパイプで自分で作ったプロセスに入力させてみたらいい感じに通信できた</p>
<p>→ただし，サンドボックスをオフにしないと通信できなかった（解決はしない）</p>
<p>SourceKit-LSPには，クライアントのための仕組みも含まれており，<code>LanguageServerProtocol</code>と<code>LanguageServerProtocolJSONRPC</code>というのが含まれており，リクエストを作成，レスポンスをデコードするのが簡単かつ型安全になる．</p>
<h4 class="title is-5 bd-anchor-title" id="safarichromeのextensionと連携する">Safari・ChromeのExtensionと連携する</h4>
<p>Safari Extensionはページがロードされたことなどをトリガーに読み込まれる</p>
<p>ブラウザ拡張では表示しているWebページにJavaScriptをインジェクトできる</p>
<p>Safari ExtensionではサンドボックはONでなくてはならない→ExtensionはサンドボックをONにして，XPCサービスを経由してサンドボックOFFのSourceKit-LSPを起動する</p>
<p>※サンドボックをOFFにしたバイナリを同梱しているので，App Storeで配布することはできない</p>
<p>ChromeではNative Messagingを代わりに使用する</p>
<h4 class="title is-5 bd-anchor-title" id="ipadでsourcekit-lspを使用する">iPadでSourceKit-LSPを使用する（！？）</h4>
<p>今の所，iOSでは動かない（SourceKit-LSPが動かないので）</p>
<p>SourceKit-LSPをLinuxサーバにデプロイし，iOSとやり取りしてiPadのWebViewからも同じ機能を提供できるようにすることを実験しているとのこと．</p>
<p>これは楽しみ．</p>
<h3 class="title is-4 bd-anchor-title" id="オープンソースaltswiftuiの発表">オープンソースAltSwiftUIの発表</h3>
<p>SwiftUIはiOS13からしか対応しておらず，この最低バージョンは今後も上がる可能性があり，そのたびに下位OSを切らなくてはならなくなる．</p>
<p>→そこで，SwiftUIと同等の機能を持ったAltSwiftUIを作って見た．</p>
<p><a href="https://github.com/rakutentech/AltSwiftUI">GitHub</a></p>
<h4 class="title is-5 bd-anchor-title" id="altswiftui">AltSwiftUI</h4>
<p>基本的なコンポーネントには対応している．</p>
<p>Stateとかも対応している．</p>
<p>プレビューとかにも対応してる</p>
<p>ObservableObjectとかによる双方向データバインディングにも対応してる（<code>@StateObject</code>でView側には書く必要がある）</p>
<p><code>@State</code>は<code>@Binding</code>で書く</p>
<p><code>@Environment</code>とかにも対応している</p>
<p>Navigationもできる</p>
<h4 class="title is-5 bd-anchor-title" id="使い方">使い方</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> RamenCell<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a> <span class="at">@StateObject</span> <span class="kw">var</span> <span class="va">model</span> <span class="op">=</span> Model<span class="op">()</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> View <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>   HStack <span class="op">{</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>     Text<span class="op">()</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>       <span class="op">.</span>font<span class="op">()</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>     Button<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>     <span class="op">}.</span>frame<span class="op">()</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>     <span class="op">.</span>cornerRadius<span class="op">()</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>     <span class="op">.</span>background<span class="op">()</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>     <span class="co">// ...（この辺にも対応してる）</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>みたいな感じで普通に書けるっぽい．</p>
<p>これがiOS 11で動くとのこと（全然仕組みとかはわからない（おそらくUIKitを裏で頑張って構築してるっぽい））</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>view<span class="op">.</span>transition<span class="op">(.</span>opacity<span class="op">)</span></span></code></pre></div>
<p>と書くと，フェードイン・アウトさせることも可能</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>Image<span class="op">(</span><span class="st">&quot;icon&quot;</span><span class="op">)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>scaleEffect<span class="op">()</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>geometryListener<span class="op">()</span></span></code></pre></div>
<p>とかやるとスクロールに合わせて画像の大きさとかを変えられる．
（<code>geometryListener</code>とかはSwiftUIには存在しないAltSwiftUIの独自機能）</p>
<p>複数行テキストを操作するときはUIKitと同じことを考慮する必要がある．</p>
<h3 class="title is-4 bd-anchor-title" id="今日からわかるavaudioengineのすべて">今日からわかるAVAudioEngineのすべて</h3>
<p>途中から参加したので初めの方は聞けなかった</p>
<h4 class="title is-5 bd-anchor-title" id="基本的な使い方">基本的な使い方</h4>
<ol type="1">
<li>AVAudioSessionをアクティブにする</li>
</ol>
<ul>
<li>このとき，<code>setPrefferedIOBufferSize()</code>とかでバッファサイズを変えられる</li>
</ul>
<ol start="2" type="1">
<li>AVAudioEngineと各Nodeの設定をする</li>
</ol>
<ul>
<li>このとき，<code>attach</code>をする必要がある．</li>
</ul>
<ol start="3" type="1">
<li>作ったNodeを<code>connect</code>（つなぎ合わせ）をする必要がある</li>
</ol>
<ul>
<li><code>engine.connect</code>をいくつかやって，<code>engine.start()</code>すると，いくつかのエフェクトとかをつけたものを流すことが可能</li>
</ul>
<h4 class="title is-5 bd-anchor-title" id="任意の音声ファイルを再生する">任意の音声ファイルを再生する</h4>
<p><code>AVAudioPlayerNode</code>を使う．これを使うと自分の声にBGMとかを重ねられる</p>
<ol type="1">
<li><code>AVAudioFile</code>を作成する．</li>
</ol>
<ul>
<li>iOSにはCAFとか言う拡張子がる．中身はAACとかOpas（？）だったりするらしい</li>
</ul>
<ol start="2" type="1">
<li><code>player.scheduleFile()</code>に<code>AVAudioFile</code>を投げると音が流れる．</li>
</ol>
<h4 class="title is-5 bd-anchor-title" id="ファイルに書き出す">ファイルに書き出す</h4>
<p>各Nodeで<code>installTap</code>とか言うのを使うとノードの出力を監視することが可能</p>
<p>→これを使ってAVAudioFileに書き込むことが可能</p>
<h4 class="title is-5 bd-anchor-title" id="音声を出力しないようにする">音声を出力しないようにする</h4>
<p>配信者のスピーカーから音声を出力しないようにしたい！</p>
<p>MixierNodeを2つ使う．</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">outputMixier</span> <span class="op">=</span> MixierNode<span class="op">()</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">muteMixier</span> <span class="op">=</span> MixierNode<span class="op">()</span></span></code></pre></div>
<p>こんなことをして<code>muteMixier</code>の音をミュートにしてこちらを端末には流し，<code>outputMixier</code>の音をライブラリに流して配信する</p>
<h4 class="title is-5 bd-anchor-title" id="rmsを取得する">RMSを取得する</h4>
<p>音圧を取りたい場合に使う．<code>installTap</code>から取得可能</p>
<h4 class="title is-5 bd-anchor-title" id="worldでボイスチェンジャーを実装する">WORLDでボイスチェンジャーを実装する</h4>
<p>WorldAppleという例があり，そこでちゃんと実装されている</p>
<p>iOSではfloat32だが，WORLDからはfloat64が来るので変換する必要がある</p>
<h3 class="title is-4 bd-anchor-title" id="j2objcを使ってjava資源をios開発で使用してみた">J2ObjCを使ってJava資源をiOS開発で使用してみた</h3>
<p>SocialHubというSNSクライアントを作る上で，iOSとAndroidで共有のロジックを入れたかったため，Java資産をiOSで使用できるようにするものを使用したかった．</p>
<h4 class="title is-5 bd-anchor-title" id="検討した技術">検討した技術</h4>
<ul>
<li>Kotin MPP
<ul>
<li>まだ知見があまりない</li>
<li>Javaのライブラリが全部使えなくなる</li>
</ul></li>
<li>Xamarinの中の.NETで書いたものを様々な環境で使えるようにするやつ
<ul>
<li>ジェネリクスが使えないという致命的な問題があるため，断念</li>
</ul></li>
<li>J2ObjC
<ul>
<li>Javaのライブラリがすべて使える</li>
<li>一応Javaで書いているので将来的にKotlin MPPへの乗り換えも考えられる</li>
</ul></li>
</ul>
<h4 class="title is-5 bd-anchor-title" id="j2objcについて">J2ObjCについて</h4>
<p>2012年にGoogleが発表（古い）</p>
<p>Javaで書いたコードをObjective-Cにトランスパイルするもの．
Javaの標準ライブラリとかもObjectiv-Cにできるので，Javaの資産をすべて仕様可能．</p>
<p>アノテーションを使用して弱参照とかNullabilityの調整とかもできる</p>
<h4 class="title is-5 bd-anchor-title" id="ビルドツール">ビルドツール</h4>
<p>対応しているツールはかなり多い
- make
- maven
- gradle</p>
<p>この内，一番いい感じにしてくれるのがGradleだったのでGradleを使用した</p>
<p>ただし，Gradleのプラグインは現状メンテされておらず，色々変えないと動かなかった</p>
<ul>
<li>Gradleのバージョンを2→4に上げた．</li>
<li>コンパイルするファイルが多すぎてコンパイラの引数が多すぎてコマンドの文字数オーバーでコンパイルができない
<ul>
<li>リンカを変えて文字数制限を打破</li>
</ul></li>
</ul>
<h4 class="title is-5 bd-anchor-title" id="その他問題点">その他問題点</h4>
<ul>
<li>JavaのClassの動的読み込み時に読み込むClassがビルドできていなくて落ちる
<ul>
<li>→先回りしてビルドするようにした</li>
</ul></li>
<li>ビルドにすごく時間がかかる
<ul>
<li>MacBook Proでやると30分くらいかかり，バッテリは半分持っていかれる</li>
<li>TravisCIを使ってみたが，リソースが貧弱でリミットの50分近くかかる</li>
<li>GitHub Actionsを使用することで時間が20分くらいに減り，いい感じになった</li>
</ul></li>
</ul>
<h4 class="title is-5 bd-anchor-title" id="まとめ">まとめ</h4>
<ul>
<li>いくつか欠点はあるが，パフォーマンスの問題はなく，iOS版のアプリの大きさも70MBほどと問題無い程度に収まった．
<ul>
<li>UIの作り込みの方に力を入れることができた</li>
</ul></li>
<li>SocialHubのライブラリ部分は<a href="https://github.com/uakihir0/SocialHub">GitHub</a>で公開されている．</li>
<li>J2ObjC-gradle（Gradleプラグイン）もフォークしたものが<a href="https://github.com/uakihir0/j2objc-gradle">GitHub</a>に上がっている</li>
</ul></article><div id="disqus_thread"></div><script>(function() { var d = document, s = d.createElement('script');s.src = 'https://clockvoid-tk.disqus.com/embed.js';s.setAttribute('data-timestamp', +new Date());(d.head || d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div><footer><div class="column is-10 is-offset-1 footer"><div class="level"><p class="level-item has-text-centered">© 2020 clockvoid</p><a href="https://twitter.com/clockvoid" class="level-item has-text-centered">Twitter</a><a href="https://github.com/clockvoid" class="level-item has-text-centered">GitHub</a><figure class="image level-item has-text-centered"><img class="is-rounded" src="https://github.com/clockvoid.png" style="height: 1.75rem; width: 1.75rem;"></figure><a href="../about.html" class="level-item has-text-centered">About</a><a href="../blog.html" class="level-item has-text-centered">Blog</a><a href="../works.html" class="level-item has-text-centered">Works</a></div></div></footer></body></html>