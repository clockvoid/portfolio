<!DOCTYPE HTML><html><head><title>clockvoid - GitHubのPRのコメントをトリガーにしてBitriseのビルドを動かす</title><meta charset="utf-8"><meta content="ie=edge" http-equiv="x-ua-compatible"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="summary" name="twitter:card"><meta content="@clockvoid" name="og:site"><meta content="GitHubのPRのコメントをトリガーにしてBitriseのビルドを動かす" name="og:title"><meta content="https://i.imgur.com/SBwBOuB.png" name="og:image"><meta content="article" name="og:type"><link href="../favicon.ico" type="image/x-icon" rel="shortcut icon"><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/dracula.min.css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>window.twttr=(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))returnt;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);t._e=[];t.ready=function(f){t._e.push(f);};return t;}(document,'script','twitter-wjs'));</script><link href="../css/mystyles.css" rel="stylesheet"></head><body class="has-navbar-fixed-top"><div class="navbar is-fixed-top has-shadow"><div class="container"><div class="navbar-brand"><div class="navbar-item"><a href="../"><figure class="image"><img style="height: 1.75rem; width: 1.75rem;" src="https://i.imgur.com/SBwBOuB.png" class="is-rounded"></figure></a></div><div onclick="document.querySelector('.navbar-menu').classList.toggle('is-active');" class="navbar-burger burger"><span></span><span></span><span></span></div></div><div class="navbar-menu"><div class="navbar-start"><a href="../" class="navbar-item">Home</a><a href="../about.html" class="navbar-item">About</a><a href="../blog.html" class="navbar-item">Blog</a><a href="../works.html" class="navbar-item">Works</a></div><div class="navbar-end"><div class="navbar-item"><a href="https://github.com/clockvoid/portfolio/blob/master/posts/2020-05-27-bitrise-trigger-by-pr-comment.md " class="button is-primary"><span class="icon"><i class="fab fa-github"></i></span><span>View it in GitHub</span></a></div></div></div></div></div><div class="container"><div class="column is-three-fifths is-offset-one-fifth"><h1 class="title">GitHubのPRのコメントをトリガーにしてBitriseのビルドを動かす</h1><a href="https://twitter.com/intent/tweet?text=GitHubのPRのコメントをトリガーにしてBitriseのビルドを動かす&amp;via=clockvoid" class="twitter-share-button">Tweet</a><p class="date">Posted on 2020-05-27  , Updated on 2020-05-28 </p><p style="margin-bottom: 1.5rem"> BitriseはGUIでワークフローの設定ができるなど，モバイル開発のCIツールとしては非常に優秀です（個人調べ）．
しかし，GitHubのPRのコメントをトリガーとしてビルドを行うことができません．
本記事では，この問題をGitHub Actionsを使って強引に解決した話を書きます． </p><article class="content"><h3 class="title is-4 bd-anchor-title" id="前提">前提</h3>
<p>皆さんはモバイル開発時のCIは何を使っていますか？ 僕は最近は主にBitriseを使っています．BitriseはGUIでプロジェクトの設定からワークフローの設定まで行うことができ，手軽です．しかも，ワークフローの中でシェルスクリプトも動かすことができるため，柔軟でもあります．自分でステップを作ることもできます．</p>
<p>ここまで来ると全く死角がないように感じますが，Jenkinsを使っていたときにはできていた，GitHubのPRにコメントをするとビルドやテストをしてくれるアレができません． 要するに，PRのコメントをトリガーに設定することができません．これは2018年の5月に投稿された<a href="https://discuss.bitrise.io/t/add-triggers-based-on-github-pr-labels/5107/10">こちらのスレッド</a>でも議論されていますが，2020年5月27日現在でも解決していません．スレッドの最後では2020年5月13日に</p>
<blockquote>
<p>Any ETA for this feature? I think its been 2 years.</p>
</blockquote>
<p>という投稿がありますが，誰も反応していません．可愛そうです．</p>
<p>僕は今回，Bitriseですべてを行うのではなく，GitHub Actionsを使って無理やりこの問題を解決しようと試みました． なお，今回はGitHub Actionsを使うことにしましたが，実際にはGitHub ActionsでもPRのコメントをトリガーとしてワークフローを動かすのは面倒くさいです．</p>
<p>実はこの試みには<a href="https://inside.pixiv.blog/kwzr/6190">元ネタ</a>があります．この元ネタではGitHubのWebHookを通じてGASからBitriseのAPIを叩いていますが，<del>これを行うためにはGASが動くサーバが必要となってきます．</del>（GASはサーバなしでもWebHookを処理できるようです．詳細は<a href="https://twitter.com/shiita_0903/status/1265990870437736449">こちら</a>．めちゃくちゃ悲しいですが，<span class="citation" data-cites="shiita_0903さん">@shiita_0903さん</span>，ありがとうございました．）基本的にはGCPでよいのですが，GCPは当方が持っているリソース的に使うことが難しかったので，GitHub Actionsを使うことにしました．GitHub ActionsはGitHubが提供している機能だし簡単だろう，とたかをくくっていたところとても面倒くさかったのでまとめることにしました．</p>
<h3 class="title is-4 bd-anchor-title" id="github-actionsでprコメントをトリガーとしてワークフローを動かす">GitHub ActionsでPRコメントをトリガーとしてワークフローを動かす</h3>
<p>まずはGitHub Actionsを使ってPRのコメントをトリガーとして何らかのワークフローを動かすことを考えます．</p>
<p>詳細は省きますが，GitHub Actionsは<code>on:</code>キーワードを使用してトリガーを設定することが可能です．基本的にはこのトリガーはORで結合されるため，<code>on:</code>に書いた条件のいずれかが適合した場合にワークフローが動きます．</p>
<p>トリガーは<a href="https://help.github.com/en/actions/reference/events-that-trigger-workflows">このページ</a>に詳しく記載されています．この中で，今回の目的に合致しそうなトリガーとしては <code>pull_request_review_comment</code>がありますが，実際にはこれでは今回の目的としては不足です．このイベントはPRのdiffコメントの投稿を示すもので，diffに対する何らかのコメントを行う必要が出てきてしまい，意味のないdiffのレビューコメントが増えてしまうので運用として適切ではありません．</p>
<p>実際に今回の目的から採用すべきなのは<code>issue_comment</code>です．Pull RequestのコメントをトリガーとするのにIssueのコメントのイベントをとってどうするんだ，という感じがしますが，どうやらPull RequestのコメントはIssueコメントと内部的には同じものみたいです．今回はこのイベントのトリガーをキャッチし，<code>job:</code>の方でフィルタします．以下にサンプルを示します．</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="at">  </span><span class="fu">issue_comment</span><span class="kw">:</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at"> created </span><span class="kw">]</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="at">    </span><span class="fu">if</span><span class="kw">:</span><span class="at"> contains(github.event.comment.html_url, '/pull/') &amp;&amp; contains(github.event.comment.body, 'please build')</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span></code></pre></div>
<p>まず，<code>on:</code>に<code>issue_comment</code>と，<code>type</code>として<code>created</code>を指定しておきます．これでコメント作成イベントが発火した際にこのワークフローがトリガーされるようになります． 続いて，<code>build:</code>ブロックのはじめに<code>if:</code>ブロックを書き，ここでPull Requestへのコメント投稿であり，コメントの内容が<code>please build</code>となっている場合のみ動くようにフィルタを設定しています． これが設定されていると，条件に合致しなかった場合は下図のように「This check was skipped」となります．</p>
<p><img src="https://i.imgur.com/C12SCqu.png" class="image is-in-article" /></p>
<p>なお，<code>if:</code>ブロックの中で<code>github.event.comment.&lt;hoge&gt;</code>というものが使用されていますが，これはGitHub Actionsのすべてのワークフロー内で使用可能なワークフローの起動条件等を取得できる環境変数です．詳細は<a href="https://help.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#contexts">こちら</a>に記載があります．</p>
<p>これでこの下の<code>steps:</code>に設定したワークフローがPRのコメントをトリガーにして動くようになりました．</p>
<h3 class="title is-4 bd-anchor-title" id="github-actionsからbitrise-apiを叩いてワークフローを開始させる">GitHub ActionsからBitrise APIを叩いてワークフローを開始させる</h3>
<p>BitriseのAPIはcurlから叩きます．必要な認証情報は，<code>APP SLUG</code>と<code>BUILD TRIGGER TOKEN</code>をcurlで使用するので，予めGitHubレポジトリのSecretに設定しておきます．設定の仕方は<a href="https://help.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets">こちら</a>を御覧ください．それぞれのトークンは下図に示すようにBitriseのCodeタブから確認できます．</p>
<p><img src="https://i.imgur.com/XkFsUHg.png" class="image is-in-article" /></p>
<p>Bitriseのワークフローをトリガーするためには，</p>
<ul>
<li>Headブランチ名</li>
<li>Baseブランチ名</li>
<li>BitriseのワークフローID</li>
<li>Pull Request番号</li>
<li>レポジトリのURL</li>
<li>コミットハッシュ</li>
</ul>
<p>が必要なので，これらのうち，上述したGitHub ActionsのContextから取得できないものは頑張ってワークフロー内で取得する必要があります．</p>
<p>この中だと2つのブランチ名とコミットハッシュはContextから取得することができません．一応<code>github.head_ref</code>と<code>github.base_ref</code>というContextが存在しますが，これらは<code>pull_request</code>イベントで発火した場合のみ使用可能になるため，今回は使用できません．また，コミットハッシュについても<code>github.sha</code>というContextが存在しますが，これはワークフローが入っているブランチ（=masterブランチ）の最新のコミットハッシュが入ってきてしまうため，Bitriseが必要とする，PRのブランチの最新のコミットハッシュを取るためには工夫が必要です．</p>
<p>そこで，以下のような環境変数を設定します．</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> get upstream branch</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="at">  </span><span class="fu">id</span><span class="kw">:</span><span class="at"> upstreambranch</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="fu">  run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>    echo &quot;::set-output name=branchname::$(curl -v -H &quot;Accept: application/vnd.github.sailor-v-preview+json&quot; -u ${{ secrets.PAT }} ${{ github.event.issue.pull_request.url }} | jq '.head.ref' | sed 's/\&quot;//g')&quot;</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> get base branch</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="at">  </span><span class="fu">id</span><span class="kw">:</span><span class="at"> basebranch</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a><span class="fu">  run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>    echo &quot;::set-output name=branchname::$(curl -v -H &quot;Accept: application/vnd.github.sailor-v-preview+json&quot; -u ${{ secrets.PAT }} ${{ github.event.issue.pull_request.url }} | jq '.base.ref' | sed 's/\&quot;//g')&quot;</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> get commit hash</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a><span class="at">  </span><span class="fu">id</span><span class="kw">:</span><span class="at"> commithash</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a><span class="fu">  run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>    echo &quot;::set-output name=hash::$(curl -v -H &quot;Accept: application/vnd.github.sailor-v-preview+json&quot; -u ${{ secrets.PAT }} ${{ github.event.issue.pull_request.url }} | jq '.head.sha' | sed 's/\&quot;//g')&quot;</span></code></pre></div>
<p>GitHubのAPIを使用してPull Requestの情報が入っているJsonを受け取り，<code>jq</code>コマンドで必要な情報を取得します．使用しているGitHubのAPIについては<a href="https://developer.github.com/v3/pulls/">こちら</a>を御覧ください．また，<code>PAT</code>というSecretを使っていますが，これはPersonal Authorize Tokenです．予め発行してSecretに追加しておいてください．</p>
<p>この環境変数を使用する際には，以下のようにします．</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="ex">steps.upstreambranch.outputs.branchname</span></span></code></pre></div>
<p>ここではGitHub ActionsのActionのoutput parameterを設定することにより，コマンドで取得した値をとってきています．詳細については<a href="https://help.github.com/en/actions/reference/workflow-commands-for-github-actions#setting-an-output-parameter">ドキュメント</a>を御覧ください．</p>
<p>続いて，取得したデータを使用し，Bitrise APIを叩きます．</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="ex">curl</span> -X POST -H <span class="st">&quot;Content-Type: application/json&quot;</span> <span class="dt">\\</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="ex">-d</span> <span class="st">'{ \\</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="st">  &quot;hook_info&quot;: { \\</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="st">    &quot;type&quot;: &quot;bitrise&quot;, \\</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="st">    &quot;build_trigger_token&quot;: &quot;${{ secrets.BUILD_TRIGGER_TOKEN }}&quot; \\</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="st">  }, \\</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a><span class="st">  &quot;build_params&quot;: { \\</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a><span class="st">    &quot;branch&quot;: &quot;${{ steps.upstreambranch.outputs.branchname }}&quot;, \\</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a><span class="st">    &quot;workflow_id&quot;: &quot;primary&quot;, \\</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a><span class="st">    &quot;branch_dest&quot;: &quot;${{ steps.basebranch.outputs.branchname }}&quot;, \\</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a><span class="st">    &quot;pull_request_id&quot;: &quot;${{ github.event.issue.number }}&quot;, \\</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a><span class="st">    &quot;pull_request_repository_url&quot;: &quot;https://github.com/${{ github.repository }}.git&quot;, \\</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a><span class="st">    &quot;pull_request_merge_branch&quot;: &quot;pull/${{ github.event.issue.number }}/merge&quot;, \\</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a><span class="st">    &quot;pull_request_head_branch&quot;: &quot;pull/${{ github.event.issue.number }}/head&quot;, \\</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a><span class="st">    &quot;commit_hash&quot;: &quot;${{ steps.commithash.outputs.hash }}&quot; \\</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a><span class="st">  }, \\</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a><span class="st">  &quot;triggered_by&quot;: &quot;curl&quot; \\</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a><span class="st">}'</span> <span class="dt">\\</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a><span class="ex">https</span>://app.bitrise.io/app/${{ secrets.APP_SLUG }}<span class="ex">/build/start.json</span></span></code></pre></div>
<p>Jsonを送っているので，Jsonの部分だけをわかりやすいようにインデントを入れています．また，上述した<code>APP SLUG</code>と<code>BUILD TRIGGER TOKEN</code>はそれぞれ<code>APP_SLUG</code>と<code>BUILD_TRIGGER_TOKEN</code>というSecretにしています．</p>
<p>使用するワークフロー名は<code>workflow_id</code>にて指定しています．<code>primary</code>を自分が実行したいワークフロー名に変えてください．</p>
<p>これでAPIを叩く事もできるようになりました．あとはすべてをまとめてYamlファイルにするだけです</p>
<h3 class="title is-4 bd-anchor-title" id="使い方">使い方</h3>
<p>まずは上述したフローで作成したYamlファイルの全体像を示します．</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> CI</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a><span class="at">  </span><span class="fu">issue_comment</span><span class="kw">:</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at"> created </span><span class="kw">]</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a><span class="at">    </span><span class="fu">if</span><span class="kw">:</span><span class="at"> contains(github.event.comment.html_url, '/pull/') &amp;&amp; contains(github.event.comment.body, 'build please')</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Dump GitHub context</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true"></a><span class="at">          </span><span class="fu">GITHUB_CONTEXT</span><span class="kw">:</span><span class="at"> ${{ toJson(github) }}</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> echo &quot;$GITHUB_CONTEXT&quot;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> get pullrequest url</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true"></a>          echo ${{ github.event.issue.pull_request.url }}</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> get upstream branch</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> upstreambranch</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true"></a>          echo &quot;::set-output name=branchname::$(curl -v -H &quot;Accept: application/vnd.github.sailor-v-preview+json&quot; -u ${{ secrets.PAT }} ${{ github.event.issue.pull_request.url }} | jq '.head.ref' | sed 's/\&quot;//g')&quot;</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> get base branch</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> basebranch</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true"></a>          echo &quot;::set-output name=branchname::$(curl -v -H &quot;Accept: application/vnd.github.sailor-v-preview+json&quot; -u ${{ secrets.PAT }} ${{ github.event.issue.pull_request.url }} | jq '.base.ref' | sed 's/\&quot;//g')&quot;</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> get commit hash</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> commithash</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true"></a>          echo &quot;::set-output name=hash::$(curl -v -H &quot;Accept: application/vnd.github.sailor-v-preview+json&quot; -u ${{ secrets.PAT }} ${{ github.event.issue.pull_request.url }} | jq '.head.sha' | sed 's/\&quot;//g')&quot;</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> make bitrise build</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true"></a>          curl -X POST -H &quot;Content-Type: application/json&quot; -d '{&quot;hook_info&quot;: {&quot;type&quot;: &quot;bitrise&quot;,&quot;build_trigger_token&quot;: &quot;${{ secrets.BUILD_TRIGGER_TOKEN }}&quot; }, &quot;build_params&quot;: { &quot;branch&quot;: &quot;${{ steps.upstreambranch.outputs.branchname }}&quot;, &quot;workflow_id&quot;: &quot;primary&quot;, &quot;branch_dest&quot;: &quot;${{ steps.basebranch.outputs.branchname }}&quot;, &quot;pull_request_id&quot;: &quot;${{ github.event.issue.number }}&quot;, &quot;pull_request_repository_url&quot;: &quot;https://github.com/${{ github.repository }}.git&quot;, &quot;pull_request_merge_branch&quot;: &quot;pull/${{ github.event.issue.number }}/merge&quot;, &quot;pull_request_head_branch&quot;: &quot;pull/${{ github.event.issue.number }}/head&quot;, &quot;commit_hash&quot;: &quot;${{ steps.commithash.outputs.hash }}&quot; }, &quot;triggered_by&quot;: &quot;curl&quot;}' https://app.bitrise.io/app/${{ secrets.APP_SLUG }}/build/start.json</span></code></pre></div>
<p>このYamlファイルを<code>.github/workflows/</code>フォルダに入れ，masterブランチにマージします．masterマージされている状態でなければ，なぜかトリガーが動きませんでした．</p>
<p>masterマージされている状態でPRに設定したコメントを投稿すると，Bitriseのビルドが走ります．</p>
<p><img src="https://i.imgur.com/OrB6NrO.png" class="image is-in-article" /></p>
<h3 class="title is-4 bd-anchor-title" id="まとめ">まとめ</h3>
<p>全体的に詳しく説明したつもりですが，自分の状況に合わせるためには</p>
<ul>
<li>Bitriseの認証情報のためのSecret</li>
<li>Bitriseワークフロー名</li>
<li>Personal Authorize Token</li>
<li>トリガーするキーワード</li>
</ul>
<p>を変更する必要があります．</p>
<p>正直言ってBitriseにはPRのコメントのトリガーを追加してほしいですし，GitHub Actionsももう少し使い勝手が良かったら嬉しいですが，仕方ないです．</p>
<p>似たような構成で使っている方は是非参考にしていただけると嬉しく思います．</p>
<h3 class="title is-4 bd-anchor-title" id="参考文献">参考文献</h3>
<ul>
<li><a href="https://github.community/t/trigger-action-via-pull-request-message/17630/12">https://github.community/t/trigger-action-via-pull-request-message/17630/12</a></li>
</ul></article><div id="disqus_thread"></div><script>(function() { var d = document, s = d.createElement('script');s.src = 'https://clockvoid-tk.disqus.com/embed.js';s.setAttribute('data-timestamp', +new Date());(d.head || d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div><footer><div class="column is-three-fifths is-offset-one-fifth footer"><div class="level"><p class="level-item has-text-centered">© 2020 clockvoid</p><a href="https://twitter.com/clockvoid" class="level-item has-text-centered">Twitter</a><a href="https://github.com/clockvoid" class="level-item has-text-centered">GitHub</a><figure class="image level-item has-text-centered"><img style="height: 1.75rem; width: 1.75rem;" src="https://i.imgur.com/SBwBOuB.png" class="is-rounded"></figure><a href="../about.html" class="level-item has-text-centered">About</a><a href="../blog.html" class="level-item has-text-centered">Blog</a><a href="../works.html" class="level-item has-text-centered">Works</a></div></div></footer></body></html>